# littlebits connector
## About littlebits
[littlebits](http://littlebits.cc/) is a company that designs and sells magnetized electronics components 
that you can snap together to easily build electronic circuits. Lego-like littlebits components are ideal to learn 
electronics while having fun. It is also an excellent choice for makers who want to rapidly build prototypes.

## Purpose of the scriptr.io connector for littlebits
The purpose of this connector is to simplify and streamline the way you access littlebits' APIs (those exposed by
the Cloudbits platform) from scriptr.io. the connector provides you with a few native objects that you can directly 
integrate into your own scripts. This will hopefully allow you to extend what you can do with littlebits by adding 
server-side logic and integrating with third party APIs and any of the devices that we support.
Note that you need to have a cloudbit device among your littlebits components.

## Components
- littlebits/cloudbits: the main entry point to communicate with the Cloudbits platform's APIs
- littlebits/cloudbitsClient: generic http client that handles the communication between scriptr.io and the Cloudbits platform. 
Used by cloudbits, devices and notifications.
- littlebits/config: used to configure the connector, mainly with littlebits data.
- littlebits/device: contains the Device class that is an abstraction of a Littlebits device.  Use instances of this class
to write/read data to/from the actual device as well as to subscribe to events emitted by the latter. 
- littlebits/notifications: handles subscriptions to events emitted by littlebits devices. Used by the device module 
but can be used directly.
- littlebits/mappings: configuration file used for internal purpose.
- littlebits/userManager: simple module to read/write user data to/from the global storage.
- littlebits/api/handleEvent: callback used as a default subscriber to events emitted by littlebits devices. 
- littlebits/notificationHandlers/DefaultHandler: this is the default handler that is triggered upon the occurrence of any
littlebits event.
- littlebits/factory: factory that contains the logic to determine the appropriate event handler to use according to the event that is received.
- littlebits/test/tests: a list of all the objects and corresponding methods, with examples on how to use them.

## How to use
- Deploy the aforementioned scripts in your scriptr.io account, in a folder named "littlebits".
- Create a Cloudbits account [here](http://littlebits.cc/cloudstart).
- Follow the Wizard to setup your device (you need to have purchased a cloudbit device).
- Once done, make sure to copy your device access token from the [Cloudbits dashboard](http://control.littlebitscloud.cc/)
and paste it into the corresponding variables in the "littlebits/config" module
- Create a test script in scriptr, or use the script provided in "littlebits/test/". 
- Once you are familiar with the connector, you can start implementing your own event hander (configure the mapping
between an event type and the handle using the "littlebits/notificationHandlers/factory" module).


### Use the connector

In order to use the connector, you need to import the main module: ```littlebits/cloudbits```, as described below:
```
var cloudbitsModule = require("littlebits/cloudbits");
```
Then create a new instance of the Cloudbits class, defined in this module 
```
var cloudbits = new cloudbitsModule.Cloudbits({userid:"1234567"}); // replace with your user id

// list all the user's devices
var list = cloudbits.listDevices();
```
In the above example, we did not pass an OAuth token to the Cloudbits constructor and therefore, the
Cloudbits instance will use the token that we have specified in the "littlebits/config" module.

To manipulate a device, ask for an instance of the Device class, passing your device id:
```
var device = cloudbits.getDevice("Your_Device_Id");
```
You can now write values to this device (i.e. generate a percentage of the output):
```
device.write({percent: 100, duration_ms: 5000}); // for example, this can light a led for 5 seconds
```
You can also subscribe to events that are generated by your device. If you do not pass the 
subscriberId parameter, the connector will use the callback URL defined in "littlebits/config" module.
```
device.addSubscriber({events:[mappings.events.VOLTAGE_JUMP]});
```
Check the content of the "littlebits/test/tests.js" file for the complete set of examples.

### About events
As mentioned, you can subscribe to events that are emitted by a given device.
By default, "littlebits" is instructed by the connector to send events to the https://api.scriptr.io/littlebits/api/handleNotifications API 
that you have deployed in your account as part of the connector. 
This API's job is to trigger the handler that is configured to process the corresponding notification type.
By default, the "/littlebits/notifications/DefaultHandler" is invoked for all the event types. 
You can implement your own handlers and configure what handler to use for what event type in the "/littlebits/factory" module.
